-- Game State Manager - Client Script
-- Place this LocalScript in StarterPlayer > StarterPlayerScripts
-- Tracks the current game state for other scripts to use

local ReplicatedStorage = game:GetService("ReplicatedStorage")

print("[GAME STATE] Loading game state manager...")

-- Wait for round status event
local roundStatusEvent = ReplicatedStorage:WaitForChild("RoundStatus", 10)

if not roundStatusEvent then
	warn("[GAME STATE] Could not find RoundStatus event!")
	return
end

-- Game state tracking
local currentState = "waitingForPlayers" -- Default state
local playerIsAliveInRound = false -- Tracks if THIS player is alive and fighting in the round

-- ==================== GLOBAL API ====================

-- Make game state accessible globally
_G.GameState = {
	-- Get current state
	getCurrentState = function()
		return currentState
	end,

	-- Check if in lobby (not in active round)
	isInLobby = function()
		return currentState == "waitingForPlayers" or currentState == "intermission"
	end,

	-- Check if in active round (GLOBAL - any round happening)
	isInRound = function()
		return currentState == "inProgress"
	end,

	-- Check if THIS PLAYER is alive and in the round (NEW)
	isPlayerAliveInRound = function()
		return playerIsAliveInRound
	end,

	-- Check if in countdown
	isInCountdown = function()
		return currentState == "countdown"
	end,
}

-- ==================== LISTEN FOR STATE CHANGES ====================

roundStatusEvent.OnClientEvent:Connect(function(status, data)
	if status == "waitingForPlayers" then
		currentState = "waitingForPlayers"
		playerIsAliveInRound = false -- Not in round
		print("[GAME STATE] State: Waiting for players")

	elseif status == "intermission" then
		currentState = "intermission"
		playerIsAliveInRound = false -- Not in round
		print("[GAME STATE] State: Intermission")

	elseif status == "countdown" then
		currentState = "countdown"
		playerIsAliveInRound = false -- Not started yet
		print("[GAME STATE] State: Countdown")

	elseif status == "roundStart" then
		currentState = "inProgress"
		-- Only mark as alive if we're actually spawning in the round (not AFK, not dead)
		playerIsAliveInRound = true
		print("[GAME STATE] State: Round in progress - Player alive in round")
	end
end)

-- ==================== TRACK PLAYER DEATH ====================

-- Listen for player death to update alive state
local player = game:GetService("Players").LocalPlayer

local function onCharacterAdded(character)
	local humanoid = character:WaitForChild("Humanoid", 5)
	if humanoid then
		humanoid.Died:Connect(function()
			-- Mark player as dead (no longer in active round)
			playerIsAliveInRound = false
			print("[GAME STATE] Player died - No longer in active round")
		end)
	end
end

-- Handle character respawns
player.CharacterAdded:Connect(onCharacterAdded)

-- Handle existing character
if player.Character then
	onCharacterAdded(player.Character)
end

print("[GAME STATE] Game state manager ready!")
